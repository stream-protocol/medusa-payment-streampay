---

# Stream Payment Gateway Smart Contract (Solana Program)

The Stream Payment Gateway Program is a Solana-based program (smart contract) designed to facilitate seamless SPL token payments with an integrated fee mechanism. This program acts as the core logic behind the Stream Payment Gateway, ensuring that payments are processed securely and efficiently on the Solana blockchain.

## Key Components:

### 1. **Solana Program Libraries**:
The program utilizes the `solana_program` and `spl_token` libraries, which provide the necessary functions and structures to interact with the Solana blockchain and SPL tokens.

### 2. **Fee Mechanism**:
A constant `FEE_PERCENTAGE` is defined, representing the fee percentage (e.g., 1%) that will be deducted from the payment amount.

### 3. **SPL Token Transfer**:
The `transfer_spl_tokens` function is responsible for transferring SPL tokens between accounts. It uses the `token_instruction::transfer` function from the `spl_token` library.

### 4. **Payment Processing**:
The `process_instruction` function is the main entry point for the program. It processes different instructions based on the provided `instruction_data`. For capturing a payment:
- The payment state is checked to ensure it's in the "Authorized" state.
- The fee is deducted from the total payment amount and transferred to the fee account.
- The remaining amount (after deducting the fee) is transferred to the merchant.

## How It Works?

1. **Initialization**:
   The program initializes by setting up the necessary libraries and defining constants.

2. **Payment Authorization**:
   Before capturing a payment, it must be authorized. This ensures that the payer has sufficient funds and is ready to make the payment.

3. **Payment Capture**:
   - The payment state is checked.
   - The fee is calculated based on the `FEE_PERCENTAGE` and deducted from the total payment amount.
   - The fee is transferred to the fee account using the `transfer_spl_tokens` function.
   - The remaining amount is transferred to the merchant.

4. **Error Handling**:
   The program has built-in error handling to ensure that only valid instructions are processed. If there's an issue (e.g., the payment state is not "Authorized"), an error is returned.

5. **Logging**:
   The `msg!` macro is used to log messages, providing insights into the program's execution.

## Conclusion:

The Stream Payment Gateway Program is a robust solution for handling SPL token payments on the Solana blockchain. With its integrated fee mechanism and secure transfer functions, it ensures that both merchants and payers have a smooth and transparent payment experience.

---