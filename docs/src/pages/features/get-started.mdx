## Creating a Gateway Program

Creating a Solana program (often referred to as a smart contract in other blockchains) for a Stream Payment Gateway is a complex task that involves multiple steps. Below is a high-level overview of the steps and a basic implementation to get you started:

### 1. Set up the Solana development environment:

Ensure you have the Solana tool suite installed. You can install it using:
```bash
$ sh -c "$(curl -sSfL https://release.solana.com/v1.17.0/install)"
```

### 2. Create a Stream Payment Gateway (project):

```bash
$ solana-keygen new --outfile ~/streampay-wallet.json
$ export SOLANA_CONFIG_DIR=~/streampay-wallet.json
$ solana config set --url https://api.devnet.solana.com
$ Program folder or (mkdir stream-payment-gateway)
$ cd program or (cd stream-payment-gateway)
$ cargo build-bpf
```

### 3. Write the Stream Payment Gateway (Solana) program:

To integrate the Solana SPL token and merchant wallet into the Stream Payment Gateway, we'll need to make use of the SPL token program's provided instructions. 
This will allow us to perform operations like transferring tokens, checking balances, and minting, etc.

**In Program folder `solana/src/lib.rs`:**

```rust
use solana_program::{
    account_info::{next_account_info, AccountInfo},
    entrypoint,
    entrypoint::ProgramResult,
    msg,
    program_error::ProgramError,
    pubkey::Pubkey,
    program_pack::Pack,
    instruction::{AccountMeta, Instruction},
};
use spl_token::{
    state::{Account as TokenAccount, Mint},
    instruction as token_instruction,
};

const FEE_PERCENTAGE: f64 = 0.01; // 1% fee

// ... (other code remains unchanged)

fn transfer_spl_tokens(
    payer: &Pubkey,
    recipient: &Pubkey,
    amount: u64,
    token_program_id: &Pubkey,
    payer_token_account: &Pubkey,
    recipient_token_account: &Pubkey,
) -> Result<Instruction, ProgramError> {
    let transfer_instruction = token_instruction::transfer(
        &token_program_id,
        &payer_token_account,
        &recipient_token_account,
        &payer,
        &[],
        amount,
    )?;
    Ok(transfer_instruction)
}

entrypoint!(process_instruction);
fn process_instruction(
    program_id: &Pubkey,
    accounts: &[AccountInfo],
    instruction_data: &[u8],
) -> ProgramResult {
    // ... (previous code)

    match instruction_data[0] {
        // ... (other cases)

        2 => {
            // Capture payment
            let mut payment = Payment::unpack(&payment_account.data.borrow())?;
            if payment.state != PaymentState::Authorized {
                return Err(ProgramError::InvalidInstructionData);
            }
            payment.state = PaymentState::Captured;

            // Deduct the fee and transfer it to the fee account
            let fee_account = next_account_info(accounts_iter)?;
            let token_program = next_account_info(accounts_iter)?;
            if *fee_account.key != payment.fee_account {
                return Err(ProgramError::InvalidAccountData);
            }

            // Transfer the fee to the fee account
            let fee_transfer_instruction = transfer_spl_tokens(
                &payment.payer,
                &payment.fee_account,
                payment.fee,
                &token_program.key,
                &payment_account.key,
                &fee_account.key,
            )?;
            solana_program::program::invoke(&fee_transfer_instruction, accounts)?;

            // Transfer the remaining amount to the merchant
            let merchant_transfer_instruction = transfer_spl_tokens(
                &payment.payer,
                &payment.recipient,
                payment.amount - payment.fee,
                &token_program.key,
                &payment_account.key,
                &payment.recipient,
            )?;
            solana_program::program::invoke(&merchant_transfer_instruction, accounts)?;

            Payment::pack(payment, &mut payment_account.data.borrow_mut())?;
            msg!("Payment captured with fee transferred");
        }

        // ... (other cases)
    }

    Ok(())
}
```

### 4. Build the Solana program:

```bash
$ cargo build-bpf
```

### 5. Deploy the Solana program to the devnet:

```bash
$ solana deploy target/deploy/stream_payment_gateway.so
```

### 6. Interact with the Solana program:

